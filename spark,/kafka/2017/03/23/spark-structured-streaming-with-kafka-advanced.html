
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Shashidhar, blogging mainly for tech. Opinions expressed are mine.">
  <meta name="author" content="Shashidhar">
  <meta name="keywords" content="">
  <link rel="canonical" href="/spark,/kafka/2017/03/23/spark-structured-streaming-with-kafka-advanced.html">
  <title>Shashidhar  | Structured Streaming with Kafka - Advanced</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!--  -->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  


  <!-- Syntax highlight in post pages -->

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">




</head>

<!-- HEAD End -->

  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="background:black;">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            <!--  -->
            Shashidhar
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#cv"> CV </a>
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
      Did you know that you can navigate the posts by swiping left and right?
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
        Awesome!
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1><strong>Structured Streaming with Kafka - Advanced</strong></h1>
          <h4><strong>23 Mar 2017</strong>
            <!-- <small> .  . <a href="/spark,/kafka/2017/03/23/spark-structured-streaming-with-kafka-advanced.html#disqus_thread">Comments</a>
            
            </small> -->
          </h4>

          <p>In the last blog we discussed about what are the ways to interact with Kafka using Spark Structured Streaming APIs.In this blog we will look into more details of the API and also different type of functionalities we get from the new API. If you havent read last blog, I advice you to go through <a href="http://shashidhare.com/spark,/kafka/2017/01/14/spark-structured-streaming-with-kafka-basic.html">Structured Streaming with Kafka - Basics</a> before going forward.</p>

<p>There are three different variations for creating Kafka streams using structured streaming APIs. They are :</p>

<ol>
  <li>Using <em>subscribe</em></li>
  <li>Using <em>subscribePattern</em></li>
  <li>Using <em>assign</em></li>
</ol>

<p>Lets go through one by one in detail</p>

<h3 id="using-subscribe">Using <em>subscribe</em></h3>
<p>This is the easiest way to create a kafka stream, we just need to give comma separated topic list while creating stream.</p>

<pre>
<code data-trim="" class="java">
    val spark = SparkSession
      .builder()
      .appName("Spark structured streaming Kafka example")
      .master("local")
      .getOrCreate()

    val inputstream = spark.readStream
        .format("kafka")
        .option("kafka.bootstrap.servers", "localhost:9092")
        .option("subscribe", "blog")
        .load()     
</code>
</pre>

<h3 id="using-subscribepattern">Using <em>subscribePattern</em></h3>
<p>Here we can specify a regex to match topic names in kafka servers. All the topics matched by regex will be used to create data stream.</p>

<pre>
<code data-trim="" class="java">
    val spark = SparkSession
      .builder()
      .appName("Spark structured streaming Kafka example")
      .master("local")
      .getOrCreate()

    val inputstream = spark.readStream
        .format("kafka")
        .option("kafka.bootstrap.servers", "localhost:9092")
        .option("subscribePattern", "\Mi\S*")
        .load()     
</code>
</pre>

<p>This will fetch data from all the topics with names starting from <em>Mi</em>.</p>

<h3 id="using-assign">Using <em>assign</em></h3>
<p>This is the most efficient from the perspective of selecting the partitions from kafka topics. In <em>assign</em> we can specify the partition numbers explicitly to fetch data from the topics. It is not directly possible with the DStream APIs which gives more power to the developer to go into the partition level selection while fetching data from Kafka topics.</p>

<pre>
<code data-trim="" class="java">
    val spark = SparkSession
      .builder()
      .appName("Spark structured streaming Kafka example")
      .master("local")
      .getOrCreate()

    val inputstream = spark.readStream
        .format("kafka")
        .option("kafka.bootstrap.servers", "localhost:9092")
        .option("assign", "{\"topicA\":[0,1],\"topicB\":[2,4]}")
        .load()     
</code>
</pre>

<p>We need to spicify the topic partitions in a JSON string format.</p>

<h3 id="offset-management-with-structured-streams">Offset Management with Structured Streams</h3>

<p>Now that we have seen different ways of creating kafka streams, lets go one level down into kafka offsets. To understand better, i will do a comparision of old DStream API way of fetching data from specific offset with new APIs</p>

<h4 id="in-dstream-api">In DStream API</h4>
<p>In DStream API we have the flexibility of fetching data from the selective offset in kafka topic by only using Kafka Direct stream API. We have to create a map of topics and partitions first, then use this Map while creating the Kafka direct stream</p>

<pre>
<code data-trim="" class="java">
    val topicPartitionTuple = new TopicPartition("topicOne", 1)
    val topicPartitionMap = Map[TopicPartition,Long](topicPartitionTuple-&gt; 0)

    val data = KafkaUtils.createDirectStream[String, String](
      ssc,
      PreferConsistent,
      Assign[String, String](Array(topicPartitionTuple).toIterable,
       kafkaMap, topicPartitionMap)
    )  
</code>
</pre>

<p>In the above code snippet, we have two numbers 1 and 0. 1 represents the parition number of topic. 0 represents the offset for the partition 1. As we see this its clearly a not very straight forward.</p>

<h4 id="in-structured-streaming-api">In Structured Streaming API</h4>
<p>Once you come to structured streaming API, its pretty easy to achieve the above mentioned scenario. We can easily specify everything in a JSON string and create the data stream from the specific paritions and specific offsets for the topic.</p>

<pre>
<code data-trim="" class="java">
    val spark = SparkSession
      .builder()
      .appName("Spark structured streaming Kafka example")
      .master("local")
      .getOrCreate()

    val inputstream = spark.readStream
        .format("kafka")
        .option("kafka.bootstrap.servers", "localhost:9092")
        .option("subscribe", "blog")
        .option("startingOffsets", "{\"blog\":{\"0\":23,\"1\":-1}}")
        .load()     
</code>
</pre>

<p>Here we have to use <em>startionOffsets</em> option, it takes a JSON formatted string of topic name with pairs of paritons and respective offsets. If you dont want to specify this type of offsets , you can just have <em>earliest or latest</em> as value for <em>startionOffsets</em> option.</p>

<p>Along with the above mentioned features in Structured Streaming API for Kafka, there are some interesting new options available. I will explain briefly about them in below section</p>

<ol>
  <li>
    <p><em>failOnDataLoss</em> - This will fail your query when data is not received from kafka. This is a good option for the program to detect failure in source. We can use this to easily determine where the problem lies. this was a difficult situaion in old APIs to have.</p>
  </li>
  <li>
    <p><em>maxOffsetsPerTrigger</em> - As the name suggests we can control the number of offsets in trigger interval. You have to remember if we dont set this value we will hit bottle necks in the data processing. It is an efficient option in a way from which we can control the overloading of the data in spark streaming programs.</p>
  </li>
</ol>

<p>Hope this blog helps you to know more about Structured Streaming APIs on Kafka. It is clearly reflecting in the APIs that, using Structured Streaming APIs we can easily create next level of streaming applicaitons with having Kafka as a streaming data source</p>



          
          <br><br>
          <div id="disqus_thread"></div>
          <br><br>
          
<!-- Social Buttons Start -->
<style>
.social-buttons {
  text-align: center !important;
  margin: 0 0 25px;
  font-size: 18px;
  line-height: 1.5;
  list-style-position: inside;
}
</style>
<ul class="list-inline social-buttons">
  
    <li><a href="https://twitter.com/shashidhares" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
    <li><a href="https://github.com/shasidhar" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="https://www.linkedin.com/in/shasidhares" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
  
    <li><a href="https://www.facebook.com/shashidhar.eranti" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


        </div>
      </div>
    </section>
    

    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>

 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-71064079-1', 'auto');
    ga('send', 'pageview');
  </script>






  <!-- Syntax highlight in post pages

  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->







  <!-- Disqus -->

  

    <script type="text/javascript">
    var disqus_shortname = 'shashidhare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>

  

  

    <!-- Comments Counter Start -->

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shashidhare'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

    <!-- Comments Counter End -->

  





  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'Structured Streaming with Kafka - Advanced', 'https://shasidhare.com/spark,/kafka/2017/03/23/spark-structured-streaming-with-kafka-advanced.html');
  }
}
</script>



  <!-- Post Gesture Navigation Start -->

  <script type="text/javascript" src="/js/hammer.min.js"></script>

  <script>
    var post = document.getElementById('post');

    new Hammer(post).on('swipeleft', function(event) {
      addTohistory();
      
        document.location.replace("/spark,/kafka/2017/01/14/spark-structured-streaming-with-kafka-basic.html");
      
    });

    new Hammer(post).on('swiperight', function(event) {
      addTohistory();
      
        document.location.replace("");
      
    });
  </script>

  <!-- Post Gesture Navigation Start -->









  <!-- Swipe Instructions for Post Start -->

  <script>
    $(document).ready(function(){
      if(!localStorage.getItem('post-swipeshowed')){
        $("#swipe-instruction").fadeIn();
        $("#swipe-instruction .close-swipe-instruction").click(function(){
          $("#swipe-instruction").fadeOut();
        });
        localStorage.setItem('post-swipeshowed', true);
      }
    });
  </script>

  <!-- Swipe Instructions for Post End -->



<!-- Javascript End -->



  </body>
</html>

<!-- Post Layout End -->
