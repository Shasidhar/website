
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Shashidhar, blogging mainly for tech. Opinions expressed are mine.">
  <meta name="author" content="Shashidhar">
  <meta name="keywords" content="">
  <link rel="canonical" href="/spark,/kafka/2017/01/14/spark-structured-streaming-with-kafka.html">
  <title>Shashidhar  | Structured Streaming with Kafka - Basic</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!--  -->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  


  <!-- Syntax highlight in post pages -->

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">




</head>

<!-- HEAD End -->

  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="background:black;">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            <!--  -->
            Shashidhar
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#cv"> CV </a>
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
      Did you know that you can navigate the posts by swiping left and right?
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
        Awesome!
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1><strong>Structured Streaming with Kafka - Basic</strong></h1>
          <h4><strong>14 Jan 2017</strong>
            <!-- <small> .  . <a href="/spark,/kafka/2017/01/14/spark-structured-streaming-with-kafka.html#disqus_thread">Comments</a>
            
            </small> -->
          </h4>

          <p>In Spark latest distribution, we have got a support for Kafka over Structured Streaming APIs. I think this is the critical piece for most of the people out there who want to use/experiment with the Structured Streaming for building streaming application. Reason being, Kafka is the defacto standard to be used as a streaming source. In this blog we will discuss about how to create Streaming pipelines with Kafka using Structured Streaming APIs.</p>

<p>Before we see how to create data streams with kafka let us briefly understand the idea of Spark’s Structured streaming. The core idea of Structured streaming stands on concept called <strong>Repeated Queries (RQ)</strong>. RQ is a simple idea of running the same queries again and again. If we look into any streaming application this is what we do essentially. The new Structured streaming introduced in Spark 2.0 is based on RQ’s. For more details on Structured streaming APIs please look into the <a href="http://spark.apache.org/docs/latest/structured-streaming-programming-guide.html">Spark Structured Streaming</a> documentation.</p>

<p>Now we got a gist about the new structured streaming concept, let’s see how we can create Kafka streams using this API. The examples in this blog will be comparing the different aspects of old DStream API with Structured Streaming API, hope that will help people to quickly start understanding the new APIs.</p>

<p><strong>NOTE</strong> We will use kafka topic name as <em>blog</em> and kafka broker as <em>localhost:9092</em> in all the following examples.</p>

<h3 id="ways-to-create-a-stream">Ways to create a Stream</h3>
<p>In any streaming application, first thing we wanted to do is create an input stream. Let’s see how we can create input stream in old and new ways</p>

<h4 id="in-dstream-api">In DStream API</h4>
<p>With respect to Kafka we can create input streams in two ways. <strong>Receiver Based approach</strong> and <strong>Direct approach</strong>. The main difference between these are in the way input data is fetched from Kafka into Spark, but once we receive the data everything else remains same for processing.</p>

<p>For all the input streams we need following parameters. We will have a map of following parameters.</p>

<ol>
  <li>kafka.bootstrap.servers -&gt; localhost:9092</li>
  <li>group.id -&gt; test</li>
  <li>zkQuorum -&gt; localhost:2181</li>
</ol>

<p>Let’s see how we use to create input DStreams.</p>

<p><strong>Receiver Based approach</strong></p>
<pre>
<code data-trim="" class="Java">
   val kafkaStream = KafkaUtils.createStream(streamingContext,zkQuorum,group.id, Map[blog-&gt;1])
</code>
</pre>

<p>The last parameter <em>Map[blog-&gt;1]</em> indicates the partitions to be consumed from the topic blog. If we want to consume more topics we just have to add more entries into this map.</p>

<p><strong>Direct approach</strong></p>
<pre>
<code data-trim="" class="Java">
    val kafkaParams = Map[String, String]("metadata.broker.list" -&gt; localhost:9092)
    val directKafkaStream = KafkaUtils.createDirectStream[
     String, String, StringDecoder, StringDecoder](
     streamingContext, kafkaParams, set("blog"))
</code>
</pre>

<p>Here we have to specify key and value types of the data received, their decoders to be used and also set of topics to be consumed.</p>

<p>These are the ways which we used till now to create DStreams from the kafka to process data in Spark. You can find more details about these two different ways to consume data from Kafka in <a href="https://spark.apache.org/docs/latest/streaming-kafka-0-8-integration.html">Spark Streaming Documentation</a></p>

<p>Now let’s shift our gears to see how to create input streams with Structured Streaming API.</p>

<h4 id="in-structured-streaming-api">In Structured Streaming API</h4>
<p>If you have already used structured streaming APIs to create dataframes/datasets, you won’t find much difference between creation of kafka input streams and dataframes.</p>

<p>Following code snippet shows how to create a <em>SparkSession</em> and then use it to create input stream of data. For better understanding on how to process a stream, I have added code to create a query which is <strong>RQ</strong> and generate output also.</p>

<pre>
<code data-trim="" class="java">
    val spark = SparkSession
      .builder()
      .appName("Spark structured streaming Kafka example")
      .master("local")
      .getOrCreate()

    val inputstream = spark.readStream
        .format("kafka")
        .option("kafka.bootstrap.servers", "localhost:9092")
        .option("subscribe", "blog")
        .load()

    val keyValueString = inputstream.selectExpr("CAST(key AS STRING)", "CAST( value AS STRING)").as[(String, String)]

    val wordCounts = keyValueString.map(_._2.split(" ")).groupBy("value").count()

    val query = wordCounts.writeStream
        .outputMode("complete")
        .format("console")
        .start()

    query.awaitTermination()        
</code>
</pre>

<p>Let’s understand what is happening in the above code snippet. First we created SparkSession. Using this session we created a DataStream from kafka for topic <em>blog</em>. Once we have the stream, we have to convert the data using standard data types. We are converting the input Key/Values to strings. Once we have the data in String, we can do any operation. Here I’m doing wordcount operation on <em>values</em>. Once we have the wordcounts we are writing results to console.</p>

<p>There are different ways we can generate the outputs from there Structured Streams. Here I’m generating the output in <em>complete</em> and writing to console. Which actually performs wordcounts for each batch and writes the counts to console. All the output modes which are supported in Structured Streaming APIs can also be used with respect to Kafka streams, for more details on output modes and how to use them refer <a href="http://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-modes">Structured Streaming documentaion</a></p>

<p>If you observe the last line, that is where we are informing spark to run all the computations for <em>query</em> are running repeatedly. Now we have seen how to create kafka streams in new APIs, let’s see what are the variations/functionalities these APIs gives us apart from the existing functionalities. One functionality I will  be discussing  here is on <em>ways to run a streaming query</em></p>

<h4 id="ways-to-run-streaming-query">Ways to run streaming query</h4>

<p>In new API we can run a query indefinitely or we can also run it for one time. <em>One time</em> has a different meaning which we will explore in the below section.</p>

<p><strong>Running Query indefinitely</strong></p>

<p>We all know this type, normally this is the way any streaming application looks. We have also used this in our program above. To run a streaming processing repeatedly we have to use <em>query.awaitTermination()</em> which is exactly same as <em>SparkStreamingContext.awaitTermination()</em>.</p>

<p><strong>Running Query one time</strong></p>

<p>Let’s say we want to run a streaming batch to consume all the existing data from Kafka and generate output. Earlier if we want to achieve this we use to start streaming program and stop gracefully. But now we have a ready API which we can use to run query to process existing data and continue other processing without stopping the context <em>query.processAllAvailable()</em>.This is useful for various applications.</p>

<p>Hope this blog helps you to get started with the Structured Streaming APIs on Kafka. In the next blog we will see what are the different variations in Kafka streams and how we can do offset management with structured streaming APIs.</p>



          
          <br><br>
          <div id="disqus_thread"></div>
          <br><br>
          
<!-- Social Buttons Start -->
<style>
.social-buttons {
  text-align: center !important;
  margin: 0 0 25px;
  font-size: 18px;
  line-height: 1.5;
  list-style-position: inside;
}
</style>
<ul class="list-inline social-buttons">
  
    <li><a href="https://twitter.com/shashidhares" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
    <li><a href="https://github.com/shasidhar" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="https://www.linkedin.com/in/shasidhares" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
  
    <li><a href="https://www.facebook.com/shashidhar.eranti" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


        </div>
      </div>
    </section>
    

    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>

 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-71064079-1', 'auto');
    ga('send', 'pageview');
  </script>






  <!-- Syntax highlight in post pages

  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->







  <!-- Disqus -->

  

    <script type="text/javascript">
    var disqus_shortname = 'shashidhare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>

  

  

    <!-- Comments Counter Start -->

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shashidhare'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

    <!-- Comments Counter End -->

  





  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'Structured Streaming with Kafka - Basic', 'https://shasidhare.com/spark,/kafka/2017/01/14/spark-structured-streaming-with-kafka.html');
  }
}
</script>



  <!-- Post Gesture Navigation Start -->

  <script type="text/javascript" src="/js/hammer.min.js"></script>

  <script>
    var post = document.getElementById('post');

    new Hammer(post).on('swipeleft', function(event) {
      addTohistory();
      
        document.location.replace("/spark/2016/07/08/building-spark-streaming-app-part-6.html");
      
    });

    new Hammer(post).on('swiperight', function(event) {
      addTohistory();
      
        document.location.replace("");
      
    });
  </script>

  <!-- Post Gesture Navigation Start -->









  <!-- Swipe Instructions for Post Start -->

  <script>
    $(document).ready(function(){
      if(!localStorage.getItem('post-swipeshowed')){
        $("#swipe-instruction").fadeIn();
        $("#swipe-instruction .close-swipe-instruction").click(function(){
          $("#swipe-instruction").fadeOut();
        });
        localStorage.setItem('post-swipeshowed', true);
      }
    });
  </script>

  <!-- Swipe Instructions for Post End -->



<!-- Javascript End -->



  </body>
</html>

<!-- Post Layout End -->
