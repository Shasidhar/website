
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Shashidhar, blogging mainly for tech. Opinions expressed are mine.">
  <meta name="author" content="Shashidhar">
  <meta name="keywords" content="">
  <link rel="canonical" href="/spark/2016/07/08/building-spark-streaming-app-part-6.html">
  <title>Shashidhar  | Building Spark Streaming App - Part 6 (Cassandra Integration)</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!--  -->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  


  <!-- Syntax highlight in post pages -->

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">




</head>

<!-- HEAD End -->

  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="background:black;">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            <!--  -->
            Shashidhar
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#cv"> CV </a>
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
      Did you know that you can navigate the posts by swiping left and right?
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
        Awesome!
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1><strong>Building Spark Streaming App - Part 6 (Cassandra Integration)</strong></h1>
          <h4><strong>08 Jul 2016</strong>
            <!-- <small> .  . <a href="/spark/2016/07/08/building-spark-streaming-app-part-6.html#disqus_thread">Comments</a>
            
            </small> -->
          </h4>

          <p>In previous <a href="http://shashidhare.com/spark/2016/07/08/building-spark-streaming-app-part-5.html">blog</a> we discussed about how we integrate kafka to our streaming engine as input source. Now our aim is to  handle output source in a better way ,where we are still using files. From our last blog we understood that using files in a production system always creates a latency. So ,in our case we actually need a NoSQL database to store our results from streaming engine. In our case we will be using Cassandra.</p>

<h3 id="why-to-use-cassandra">Why to use Cassandra?</h3>
<p>Cassandra is the most widely used distributed data source in the industry. It can scale out very easily and handle huge amounts of data transfer very efficiently. In our case we need a better mechanism than files to over come latency of the reporting induced by files. WIth files as output , we always need a full file scan to retrieve results and we cannot directly do lookups.</p>

<p>If we look into our results we really need a database which can handle timeseries data analysis, with cassandra data model we can easily achieve the time series aggregations very effectively.</p>

<h3 id="cassandra-spark-integration">Cassandra Spark integration</h3>

<p>In spark we have a very good support to use cassandra as data source. Cassandra officially maintains a connector for spark and supports all the latest features of spark in this connector. At high level the connector handles data load from cassandra into spark as RDDs. It supports all data type conversions and advanced data types of cassandra too. All standard spark-sql queries can be directly executed on cassandra with this connector.</p>

<p>For more information about spark cassandra connector use <a href="https://github.com/datastax/spark-cassandra-connector">link</a>.</p>

<h3 id="cassandra-as-output-store">Cassandra as output store.</h3>

<p>Now let’s directly get into the business of working with cassandra. If we see our previous results that we have generated using files we generated hourly aggregations for different groups like city, state and country. Similarly we will have these hourly aggregations here also but as a tables inside cassandra now.</p>

<p>In my <a href="http://shashidhare.com/spark/2016/05/08/building-spark-streaming-app-part-2.html">second blog</a> of this series we have discussed our output results will be three tables with following structure.</p>

<ol>
  <li>CountryWiseStats - (datetime,country.count)</li>
  <li>StateWiseStats - (datetime,state.count)</li>
  <li>CityWiseStats - (datetime,city,sensorstatus.count)</li>
</ol>

<p>Now we want to connect with cassandra in spark and populate the results into these tables. The way we create cassandra data source in spark is.</p>

<pre>
<code data-trim="" class="Java">
   sparkConf.set("spark.cassandra.connection.host", "127.0.0.1") // Set parameter into spark configuration
   val sqlContext = SQLContext.getOrCreate(sparkContext)
</code>
</pre>

<p>Once we create the sqlContext with cassandra parameter in environment, we can directly read and write back data from casssandra to spark.</p>

<pre>
<code data-trim="" class="Java">
   val countrystats = sqlContext.read.format("org.apache.spark.sql.cassandra").
   options(Map( "table" -&gt; "countrystats", "keyspace" -&gt; "sensoranalytics")).load()
</code>
</pre>

<p>The key point to observe in this change from files to cassandra as datastore is, how we store the results. In files we just calculate the aggregate and store into a file. Once we get into a database level, the way to store the results should change because there is no guarantee that for a given hour we get all the records in a single batch of streaming. Remember we generate the results from spark streaming application as hourly aggregates. So, we need to keep track of already existing aggregates for a given hour in database and update them if they exist or else create new entry.</p>

<p>There are two possible ways to handle the updates. One way is to calculate aggregates for a given batch data and based on the aggregated data ,construct cassandra query and update the database. Second way is just read all the data from cassandra irrespective of what is being received in a batch and update and write back to cassandra. Within these options , it’s obvious that second is more memory consuming and not much effective so we will go with first approach. Following is the code sample for country stats aggregate calculations.</p>

<pre>
<code data-trim="" class="Java">

    val countryAggregation = dstream.map(sensorRec=&gt;((dateFormat.format(sensorRec.dateTime),sensorRec.country),1))

    val resultStream = countryAggregation.window(Seconds(windowInterval),Seconds(slideInterval)).
    	groupByKey().mapValues(_.size)

    val joinStream = resultStream.transform(eachRdd=&gt;{
      if(!eachRdd.isEmpty()){
        val sqlContext = SQLContext.getOrCreate(eachRdd.sparkContext)
        val datesList = eachRdd.map{
          case ((date,country),count) =&gt; s"'$date'"
        }.distinct().collect().toList.mkString(",")
        val countryList = eachRdd.map{
          case ((date,country),count) =&gt; s"'$country'"
        }.distinct().collect().toList.mkString(",")

        val options = Map("keyspace" -&gt; "sensoranalytics", "table" -&gt; "countrystats")
        val countrystatsdf = dataLoader.getData(options,eachRdd.sparkContext).get

        countrystatsdf.registerTempTable("countrystats")
        val existingRdd = sqlContext.sql(s"select * from countrystats where date in ($datesList) and country in 
          ($countryList)").map {
          case Row(date: String, country: String, count: Int) =&gt; ((date, country), count)
        }
        eachRdd.union(existingRdd).reduceByKey(_+_)
      }else{
        eachRdd
      }
    })

    joinStream.map{
      case ((date,country),count) =&gt; CountryWiseStats(date,country,count)
    }
</code>
</pre>

<p>Here we are taking a <em>DStream[SensorRecord]</em> and populating the DStream[CountryWiseStats] which can be stored into cassandra. For other aggregates like stateWiseStats and cityWiseStats refer the <a href="https://github.com/Shasidhar/sensoranalytics">Github repo</a>.</p>

<p>The way to store the results into cassandra is pretty straight forward. You can directly call a save method for any dataframe to save results.</p>

<pre>
<code data-trim="" class="Java">
   countryStats.saveToCassandra("sensoranalytics","countrystats",SomeColumns("date","country","count"))
</code>
</pre>

<h3 id="zeppelin-cassandra-integration">Zeppelin Cassandra integration</h3>

<p>Once we change our output from files to cassandra we also need to modify zeppelin to read data from cassandra rather than files. With zeppelin the only thing we need to change is , the way of reading results and creating the initial dataframes for each aggregate. Cassandra connector has a direct method to read data from cassandra table and it’s exactly same as we have done earlier in spark streaming code.</p>

<pre>
<code data-trim="" class="Java">
   val countryStatDF =  sc.cassandraTable("sensoranalytics","countrystats").map(row=&gt;{
   val cal = Calendar.getInstance()
   cal.setTimeInMillis(DateTimeFormat.forPattern(pattern).parseDateTime(row.get[String]("date")).getMillis)
    countryStats(new Date(cal.getTimeInMillis),cal.get(Calendar.HOUR_OF_DAY),row.get[String]("country"),
    row.get[Int]("count"))}).toDF
</code>
</pre>

<p>In order to connect to cassandra and use cassandra libraries in Zeppelin we need to set cassandra into Zeppelin class path. Please refer to Readme in the <a href="https://github.com/Shasidhar/sensoranalytics/blob/master/README.md">github repo</a> for the classpath settings.</p>

<p><em>For complete code refer</em> <strong><em>cassandra branch</em></strong> <em>of <a href="https://github.com/Shasidhar/sensoranalytics">Sensor analytics</a> repository</em></p>

<p>In the repo there are some code snippets for testing the streaming application. Have a look on the tests of streaming code which is quite unconventional from the other unit tests. To give brief idea about testing streaming application, we need to keep track of clock which plays a key role in testing streaming application. Since time is the main factor in spark streaming framework, for testing its better if we manage time rather than keeping waits in test cases and wait for results.</p>

<p>This completes my blog series on building end to end streaming application using apache spark. Hope you enjoyed and learnt basics of streaming application.</p>



          
          <br><br>
          <div id="disqus_thread"></div>
          <br><br>
          
<!-- Social Buttons Start -->
<style>
.social-buttons {
  text-align: center !important;
  margin: 0 0 25px;
  font-size: 18px;
  line-height: 1.5;
  list-style-position: inside;
}
</style>
<ul class="list-inline social-buttons">
  
    <li><a href="https://twitter.com/shashidhares" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
    <li><a href="https://github.com/shasidhar" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="https://www.linkedin.com/in/shasidhares" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
  
    <li><a href="https://www.facebook.com/shashidhar.eranti" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


        </div>
      </div>
    </section>
    

    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>

 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-71064079-1', 'auto');
    ga('send', 'pageview');
  </script>






  <!-- Syntax highlight in post pages

  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->







  <!-- Disqus -->

  

    <script type="text/javascript">
    var disqus_shortname = 'shashidhare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>

  

  

    <!-- Comments Counter Start -->

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shashidhare'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

    <!-- Comments Counter End -->

  





  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'Building Spark Streaming App - Part 6 (Cassandra Integration)', 'https://shasidhare.com/spark/2016/07/08/building-spark-streaming-app-part-6.html');
  }
}
</script>



  <!-- Post Gesture Navigation Start -->

  <script type="text/javascript" src="/js/hammer.min.js"></script>

  <script>
    var post = document.getElementById('post');

    new Hammer(post).on('swipeleft', function(event) {
      addTohistory();
      
        document.location.replace("/spark/2016/07/08/building-spark-streaming-app-part-5.html");
      
    });

    new Hammer(post).on('swiperight', function(event) {
      addTohistory();
      
        document.location.replace("/spark,/kafka/2017/01/14/spark-structured-streaming-with-kafka-basic.html");
      
    });
  </script>

  <!-- Post Gesture Navigation Start -->









  <!-- Swipe Instructions for Post Start -->

  <script>
    $(document).ready(function(){
      if(!localStorage.getItem('post-swipeshowed')){
        $("#swipe-instruction").fadeIn();
        $("#swipe-instruction .close-swipe-instruction").click(function(){
          $("#swipe-instruction").fadeOut();
        });
        localStorage.setItem('post-swipeshowed', true);
      }
    });
  </script>

  <!-- Swipe Instructions for Post End -->



<!-- Javascript End -->



  </body>
</html>

<!-- Post Layout End -->
