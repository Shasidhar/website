
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Shashidhar, blogging mainly for tech. Opinions expressed are mine.">
  <meta name="author" content="Shashidhar">
  <meta name="keywords" content="">
  <link rel="canonical" href="/spark/2016/01/20/unit-test-spark-streaming-receiver.html">
  <title>Shashidhar  | Unit testing Spark Streaming Receiver</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!--  -->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  


  <!-- Syntax highlight in post pages -->

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">




</head>

<!-- HEAD End -->

  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="background:black;">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            <!--  -->
            Shashidhar
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#cv"> CV </a>
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
      Did you know that you can navigate the posts by swiping left and right?
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
        Awesome!
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1><strong>Unit testing Spark Streaming Receiver</strong></h1>
          <h4><strong>20 Jan 2016</strong>
            <!-- <small> .  . <a href="/spark/2016/01/20/unit-test-spark-streaming-receiver.html#disqus_thread">Comments</a>
            
            </small> -->
          </h4>

          <p>Spark is the most popular platform for all  Bigdata needs now a days. As per the recent trend, Spark is  defacto for Bigdata needs and quite popular in production as well. What I really mean is, people are pretty comfortable with the development of Spark solutions as Spark exposes pretty simple and powerful API’s for the programmers to work with. But there are many more things in a Software process , like testing, code quality checks etc. But being developers we need to show how our code can be tested through some basic Unit tests. This blog tends to focus on Unit testing Spark.</p>

<p>If we think of Unit testing we tend to follow the same ideas of JUnit to accomplish the task, but Spark is a pretty complex system and its very hard for everyone to get over with its unit testing easily. With Spark Streaming things become pretty complex.</p>

<p>In any streaming applications we will be having two layers of abstraction</p>

<ul>
  <li>Receiver - where we receive the data from sources like Kafka, File , Network etc</li>
  <li>Processor - which actually process the data received from receivers.</li>
</ul>

<p>I feel unit testing the processer is pretty straight forward, so my focus in this blog will be on writing unit test for the Spark Streaming Receivers with Kafka being the source for streaming.</p>

<p>Lets see what are the prerequisites we need for unit testing. Since we want to test spark streaming receiver which is fetching data from Kafka we need to have all the following components started to be able to test.</p>

<ul>
  <li>SparkContext - Pre requisite for any Spark operation</li>
  <li>SparkStreamingContext - Needed for streaming application</li>
  <li>Zookeeper - Pre requisite for Kafka</li>
  <li>Kafka - Needed because we want to fetch data from Kafka</li>
</ul>

<p>If we look at the above components we can start Spark and Spark Streaming context in setup method. To emulate the Kafka and Zookeeper for our test case we will use <a href="https://spark.apache.org/docs/latest/api/java/index.html?org/apache/spark/streaming/kafka/KafkaUtils.html">KafkaUtils</a>.</p>

<p>For complete code check <a href="https://github.com/Shasidhar/spark_streaming_receiver_test">Spark Streaming Receiver Test</a></p>

<p>Lets break the task into different steps,</p>

<h4 id="make-test-setup">Make test setup</h4>

<pre>
<code data-trim="" class="java">
    @Before
    public void setUp() {
        kafkaTestUtils = new KafkaTestUtils();
        kafkaTestUtils.setup();
        SparkConf sparkConf = new SparkConf()
                        .setMaster("local[4]").setAppName(this.getClass().getSimpleName());
        ssc = new JavaStreamingContext(sparkConf, new Duration(500));
    }
</code>
</pre>

<h4 id="make-kafka-ready">Make Kafka ready</h4>
<p>We need to create a topic and pass some data into the topic. The data stored into Kafka will be used to match the received data from stream received from Kafka in the end. In this step we will create kafka topic and save data into the topic.</p>

<pre>
<code data-trim="" class="java">
    String topic = "topic";
    Map&lt;String, Integer&gt; topics = new HashMap&lt;String, Integer&gt;();
    topics.put(topic, 1);
    String[] sent = new String[3];
    sent[0] = "first";
    sent[1] = "second";
    sent[2] = "third";
    kafkaTestUtils.createTopic(topic);
    kafkaTestUtils.sendMessages(topic, sent);
</code>
</pre>

<h4 id="create-input-stream-and-compare-results-with-source">Create input stream and compare results with source</h4>

<p>Now we have the data ready in Kafka we will create a DStream from the topic we created earlier using <a href="https://spark.apache.org/docs/latest/api/java/org/apache/spark/streaming/kafka/KafkaUtils.html">KafkaUtils</a></p>

<p>Now we will create kafka input stream and modify the final stream because we don’t want to keep track of the Keys generated by kafka.</p>

<p>Once we have the input stream we will extract data from the stream and compare with input data.</p>

<pre>
<code data-trim="" class="Java">
    JavaDStream<string> stream = KafkaUtils.createStream(ssc,
    String.class,
    String.class,
    StringDecoder.class,
    StringDecoder.class,
    kafkaParams,
    topics,
    StorageLevel.MEMORY_ONLY_SER())
    .map(new Function&lt;Tuple2&lt;String, String&gt;, String&gt;()
    {
    public String call(Tuple2&lt;String, String&gt; stringStringTuple2) throws Exception
        {
            return stringStringTuple2._2();
        }
    });
    stream.foreachRDD(new Function&lt;JavaRDD<string>, Void&gt;()
    {
    public Void call(final JavaRDD<string> v1) throws Exception
      {
          received.addAll(v1.collect());
          return null;
          }
      });
    Assert.assertEquals(sentList.size(), received.size());


</string></string></string></code></pre>



          
          <br><br>
          <div id="disqus_thread"></div>
          <br><br>
          
<!-- Social Buttons Start -->
<style>
.social-buttons {
  text-align: center !important;
  margin: 0 0 25px;
  font-size: 18px;
  line-height: 1.5;
  list-style-position: inside;
}
</style>
<ul class="list-inline social-buttons">
  
    <li><a href="https://twitter.com/shashidhares" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
    <li><a href="https://github.com/shasidhar" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="https://www.linkedin.com/in/shasidhares" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
  
    <li><a href="https://www.facebook.com/shashidhar.eranti" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


        </div>
      </div>
    </section>
    

    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>

 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-71064079-1', 'auto');
    ga('send', 'pageview');
  </script>






  <!-- Syntax highlight in post pages

  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->







  <!-- Disqus -->

  

    <script type="text/javascript">
    var disqus_shortname = 'shashidhare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>

  

  

    <!-- Comments Counter Start -->

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shashidhare'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

    <!-- Comments Counter End -->

  





  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'Unit testing Spark Streaming Receiver', 'https://shasidhare.com/spark/2016/01/20/unit-test-spark-streaming-receiver.html');
  }
}
</script>



  <!-- Post Gesture Navigation Start -->

  <script type="text/javascript" src="/js/hammer.min.js"></script>

  <script>
    var post = document.getElementById('post');

    new Hammer(post).on('swipeleft', function(event) {
      addTohistory();
      
        document.location.replace("/spark/2015/11/03/apache-spark-performance-tuning.html");
      
    });

    new Hammer(post).on('swiperight', function(event) {
      addTohistory();
      
        document.location.replace("");
      
    });
  </script>

  <!-- Post Gesture Navigation Start -->









  <!-- Swipe Instructions for Post Start -->

  <script>
    $(document).ready(function(){
      if(!localStorage.getItem('post-swipeshowed')){
        $("#swipe-instruction").fadeIn();
        $("#swipe-instruction .close-swipe-instruction").click(function(){
          $("#swipe-instruction").fadeOut();
        });
        localStorage.setItem('post-swipeshowed', true);
      }
    });
  </script>

  <!-- Swipe Instructions for Post End -->



<!-- Javascript End -->



  </body>
</html>

<!-- Post Layout End -->
