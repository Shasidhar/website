
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Shashidhar, blogging mainly for tech. Opinions expressed are mine.">
  <meta name="author" content="Shashidhar">
  <meta name="keywords" content="">
  <link rel="canonical" href="/spark/2016/03/05/zookeeper-offset-management-in-kafka-direct-stream.html">
  <title>Shashidhar  | Zookeeper Offset Management In Kafka Direct Stream</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!--  -->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  


  <!-- Syntax highlight in post pages -->

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.2/styles/monokai_sublime.min.css">




</head>

<!-- HEAD End -->

  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="background:black;">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            <!--  -->
            Shashidhar
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#cv"> CV </a>
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
      Did you know that you can navigate the posts by swiping left and right?
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
        Awesome!
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1><strong>Zookeeper Offset Management In Kafka Direct Stream</strong></h1>
          <h4><strong>05 Mar 2016</strong>
            <!-- <small> .  . <a href="/spark/2016/03/05/zookeeper-offset-management-in-kafka-direct-stream.html#disqus_thread">Comments</a>
            
            </small> -->
          </h4>

          <p>Kafka is the most popular source for Spark streaming application because of various benefits we get from Kafka. As you know Spark streaming has the concept of <strong>Receivers</strong> which is responsible to receive data from the input sources of any streaming application and store it in memory for processing. But there is a special approach supported by Spark Streaming engine for Kafka input source which is called as <strong>Direct Approach (No Receivers)</strong></p>

<p>To give a brief introduction about this <strong>Direct Approach</strong>, in this approach spark streaming engine directly queries the data from Kafka without receivers periodically and also defines the offset ranges to process for each batch. Here Spark uses Kafka low level consumer API instead of the high level API used in the receiver based kafka input sources. Also Spark Streaming engine follows the Kafka partitioning scheme in this approach.</p>

<p>Now its clear that offset ranges are managed by Spark automatically, we will not see the offset ranges getting updated in the Zookeeper as it happens in receiver based approach. So there is some work here which needs to be done by the programmers to track the kafka offset ranges for each batch on our own.</p>

<p><strong><em>Why we want to store these kafka offset ranges?</em></strong></p>

<p>If we dont save them , we cannot do the following</p>

<ol>
  <li>
    <p>Zookeeper based Kafka monitoring tools will not work. Because these tools expect consumer offsets being updated in the Zookeeper so that the monitoring UI will show the real time status of the data being processed.</p>
  </li>
  <li>
    <p>If checkpointing is not enabled in Spark streaming, we cannot resume the jobs from where it is left in case of failures.</p>
  </li>
</ol>

<p>In this blog, we will see how we can get the Offset’s of the kafka topics consumed from Spark DStreams and how to store them in Zookeeper so that the monitoring tools will show the job progress.</p>

<h4 id="extract-offset-ranges-from-dstream">Extract Offset ranges from DStream</h4>

<pre>
<code data-trim="" class="Java">
    final AtomicReference&lt;OffsetRange[]&gt; offsetRanges = new AtomicReference&lt;&gt;();
    
    directKafkaStream.transformToPair(
        new Function&lt;JavaPairRDD&lt;String, String&gt;, JavaPairRDD&lt;String, String&gt;&gt;() {
        @Override
        public JavaPairRDD&lt;String, String&gt; call(JavaPairRDD&lt;String, String&gt; rdd) throws Exception {
        OffsetRange[] offsets = ((HasOffsetRanges) rdd.rdd()).offsetRanges();
        offsetRanges.set(offsets);
        return rdd;
            }
        }
    ).foreachRDD(
        new Function&lt;JavaPairRDD&lt;String, String&gt;, Void&gt;() {
        @Override
        public Void call(JavaPairRDD&lt;String, String&gt; rdd) throws IOException {
        for (OffsetRange o : offsetRanges.get()) {
             System.out.println(
            o.topic() + " " + o.partition() + " " + o.fromOffset() + " " + o.untilOffset()
            );
        }
        return null;
            }
        }
    );
</code>
</pre>

<p>In the above code we are extracting the Offsets from the DStream and printing into console.</p>

<p><strong>NOTE:</strong> you can typecast the rdd into HasOffsetRanges only in the first method after you create direct stream from Kafka not in the subsequent calls. Also the partitioning of the rdd’s change if you perform any operations that includes shuffle.</p>

<p>So, its better to call transform and process the offsets just after the direct stream. Later any normal DStream operations can be performed according to the application needs.</p>

<h4 id="save-the-offsets-into-zookeeper">Save the Offsets into Zookeeper</h4>

<p>Now we see how the offsets should be stored inside Zookeeper. Normally Kafka consumer offsets are stored in Zookeeper in the <strong><em>consumers/[groupId]/offsets/[topic]/[partitionId] -&gt; long (offset)</em></strong> path.</p>

<p>In below code i’m extracting the offsets and storing into the corresponding node in Zookeeper with Curator clients.</p>

<pre>
<code data-trim="" class="Java">
    final AtomicReference&lt;OffsetRange[]&gt; offsetRanges = new AtomicReference&lt;&gt;();
    final CuratorFramework  curatorFramework = CuratorFrameworkFactory..namespace("testgroup").builder().connectString("<zookeeperhost>:<port>").connectionTimeoutMs(1000).sessionTimeoutMs(10000).retryPolicy(new RetryUntilElapsed(1000, 1000)).build();

    curatorFramework.start();
    final ObjectMapper objectMapper = new ObjectMapper();

    directKafkaStream.transformToPair(
        new Function&lt;JavaPairRDD&lt;String, String&gt;, JavaPairRDD&lt;String, String&gt;&gt;() {
        @Override
        public JavaPairRDD&lt;String, String&gt; call(JavaPairRDD&lt;String, String&gt; rdd) throws Exception {
        OffsetRange[] offsets = ((HasOffsetRanges) rdd.rdd()).offsetRanges();
        offsetRanges.set(offsets);
        return rdd;
            }
        }
    ).foreachRDD(
        new Function&lt;JavaPairRDD&lt;String, String&gt;, Void&gt;() {
        @Override
        public Void call(JavaPairRDD&lt;String, String&gt; rdd) throws IOException {
        for (OffsetRange o : offsetRanges.get()) {
            final byte[] offsetBytes = objectMapper.writeValueAsBytes(outputObj.getEndOffset());
            String nodePath = "/testgroup/offsets/" + o.topic()+ "/" + o.partition();

            if(curatorFramework.checkExists().forPath(nodePath)!=null){
                    curatorFramework.setData().forPath(nodePath,offsetBytes);
                }else{
                    curatorFramework.create().creatingParentsIfNeeded().forPath(nodePath, offsetBytes);
                }
        }
        return null;
            }
        }
    );


</port></zookeeperhost></code></pre>



          
          <br><br>
          <div id="disqus_thread"></div>
          <br><br>
          
<!-- Social Buttons Start -->
<style>
.social-buttons {
  text-align: center !important;
  margin: 0 0 25px;
  font-size: 18px;
  line-height: 1.5;
  list-style-position: inside;
}
</style>
<ul class="list-inline social-buttons">
  
    <li><a href="https://twitter.com/shashidhares" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
    <li><a href="https://github.com/shasidhar" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="https://www.linkedin.com/in/shasidhares" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
  
    <li><a href="https://www.facebook.com/shashidhar.eranti" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


        </div>
      </div>
    </section>
    

    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>

 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-71064079-1', 'auto');
    ga('send', 'pageview');
  </script>






  <!-- Syntax highlight in post pages

  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>-->







  <!-- Disqus -->

  

    <script type="text/javascript">
    var disqus_shortname = 'shashidhare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>

  

  

    <!-- Comments Counter Start -->

    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shashidhare'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>

    <!-- Comments Counter End -->

  





  <!-- Share buttons Start -->

  <script src="/js/rrssb.min.js"></script>

  <!-- Share buttons End -->





<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'Zookeeper Offset Management In Kafka Direct Stream', 'https://shasidhare.com/spark/2016/03/05/zookeeper-offset-management-in-kafka-direct-stream.html');
  }
}
</script>



  <!-- Post Gesture Navigation Start -->

  <script type="text/javascript" src="/js/hammer.min.js"></script>

  <script>
    var post = document.getElementById('post');

    new Hammer(post).on('swipeleft', function(event) {
      addTohistory();
      
        document.location.replace("/spark/2016/01/20/unit-test-spark-streaming-receiver.html");
      
    });

    new Hammer(post).on('swiperight', function(event) {
      addTohistory();
      
        document.location.replace("");
      
    });
  </script>

  <!-- Post Gesture Navigation Start -->









  <!-- Swipe Instructions for Post Start -->

  <script>
    $(document).ready(function(){
      if(!localStorage.getItem('post-swipeshowed')){
        $("#swipe-instruction").fadeIn();
        $("#swipe-instruction .close-swipe-instruction").click(function(){
          $("#swipe-instruction").fadeOut();
        });
        localStorage.setItem('post-swipeshowed', true);
      }
    });
  </script>

  <!-- Swipe Instructions for Post End -->



<!-- Javascript End -->



  </body>
</html>

<!-- Post Layout End -->
