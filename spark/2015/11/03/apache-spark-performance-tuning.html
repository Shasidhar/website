
<!-- Post Layout Start -->

<!DOCTYPE html>
<html lang="en">

  
<!-- HEAD Start -->

<head>
  


  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Blog and website of Shashidhar, blogging mainly for tech. Opinions expressed are mine.">
  <meta name="author" content="Shashidhar">
  <meta name="keywords" content="">
  <link rel="canonical" href="/spark/2015/11/03/apache-spark-performance-tuning.html">
  <title>Shashidhar  | Apache Spark Performance Tuning</title>

  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Custom CSS -->
  <link href="/css/grayscale.css" rel="stylesheet">
  

  <!-- Custom Fonts -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
  <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/rrssb.css" />
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
  <!--  -->

  

  


  <!-- iOS Web App mode -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" sizes="36x36" href="/img/web-app/icon-36p.png">
  <link rel="apple-touch-icon" sizes="48x48" href="/img/web-app/icon-48p.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/web-app/icon-72p.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/img/web-app/icon-96p.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/web-app/icon-144p.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/img/web-app/icon-192p.png">

  <!-- Android Web App mode -->

  <link rel="manifest" href="/manifest.json">




  



</head>

<!-- HEAD End -->


  <body>

    
<!-- Navigation Start -->

<nav class="navbar navbar-custom navbar-fixed-top" role="navigation" style="background:black;">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-main-collapse">
        <i class="fa fa-bars"></i>
      </button>
      
        <a class="navbar-brand" href="/">
      
          <div>
            <!--  -->
            Shashidhar
          </div>
        </a>
    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-right navbar-main-collapse">
      <ul class="nav navbar-nav">
        
          <!-- Blog, Post, Tag and Error pages -->
          
            <li>
            
                <a href="/#about"> About </a>
            
            </li>
          
            <li>
            
              
                <a href="/blog/"> Blog </a>
              
            
            </li>
          
            <li>
            
                <a href="/#cv"> CV </a>
            
            </li>
          
            <li>
            
                <a href="/#timeline"> Timeline </a>
            
            </li>
          
            <li>
            
                <a href="/#contact"> Contact </a>
            
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>

<!-- Navigation End -->


    <section id="post" class="container content-section">
      <div class="row">
        <div class="col-md-10 col-md-offset-1">

          
<!-- Swipe Instructions Start -->

<div id="swipe-instruction">
  <div>
    <p><br><br><br></p>
    <i id="hand-swipe" class="fa fa-hand-o-up"></i>
    <p><strong>
    
    </strong></p>
    <button type="button" class="btn btn-default ok-btn close-swipe-instruction">
      
    </button>
  </div>
</div>

<!-- Swipe Instructions End -->


          <h1 class="text-center"><strong>Apache Spark Performance Tuning</strong></h1>
          <h4><strong>03 Nov 2015</strong>
            <!-- <small> .  . <a href="/spark/2015/11/03/apache-spark-performance-tuning.html#disqus_thread">Comments</a>
            
            </small> -->
          </h4>

          <p>As we all know Apache Spark is the  most popular framework now a days for Big Data solutions, in this blog we will try to analyse different key factors that can be used to improve the performance of Spark applications in production.</p>

<p>Below factors play vital role in improving performance of Spark applications.</p>

<h2 id="quantity-of-the-data-shuffled">Quantity of the data shuffled</h2>

<p>As we know, shuffle is the most costly operation in Spark which involves movement of the data in the cluster. You should always try to decrease size of data for shuffling to increase application performance. One common solution to achieve this is, always filter data before shuffle phase rather than after.</p>

<h2 id="degree-of-parallelism">Degree of Parallelism</h2>

<p>Always try to avoid the empty partitions. Generally if we have a filtering operation the result of the filtering operation reduces the size of data. If the filter operation is explicitly selective then there is always a chance that filtering operation ends up giving some of the partitions with very less data or sometimes no data. As soon as the size of data per partition decreases the situation arises where, time to launch the tasks for the empty partitions becomes overhead and reduces the performance significantly. Solution here is to use coalesce operation and reduce number of partitions after filtering.</p>

<p>If your job is taking a long time and your cluster is not utilised completely, try to use <strong>repartition</strong> operation. Repartitioning allows you to increase/decrease the number of partitions of your job. In this case try to increase the number of partitions so that cluster is used efficiently. It might be expensive operation because when you call repartition some data is shuffled across the cluster. But if the operation you are doing is expensive and if you can use your empty cluster cores to parallelise the process, it can be beneficiary to call <strong>repartition</strong> on your data.</p>

<h2 id="choice-of-serializer">Choice of serializer</h2>

<p>In spark serialization happens whenever we perform <strong>*cache</strong> and <strong>shuffle</strong> operations. As I have already mentioned shuffle is the most costly operation in Spark. By default Spark uses java serialization which is very robust and has support for all types of data but it is very slow. Apart from this, spark has built in support for Kryo serialization. Kryo serialization is faster and has out of the box support inside Spark. To use it follow the below steps</p>

<ul>
  <li>Change the spark configuration settings to use <strong>Kryo</strong> serializer.</li>
</ul>

<pre>
<code data-trim="" class="Scala">
 val conf = new SparkConf()
 conf.set("spark.serializer","org.apache.spark.serializer.KryoSerializer")
</code>
</pre>

<ul>
  <li>Register all the classes which are serialized. Registration helps kryo to reduce the amount of metadata written as part of the serialization and decreases unwanted overhead. This adds up some of the boiler plate code inside your application.</li>
</ul>

<pre>
<code data-trim="" class="Scala">
 conf.set("spark.kryo.registrattionRequired","true")
 conf.registerKryoClasses(Array(classOf[*yourClass*],classOf[*yourClass1*]))
</code>
</pre>

<h2 id="cache-format">Cache Format</h2>

<p>In Spark whenever we cache the data it is stored using <strong>MEMORY_ONLY</strong> level in the form of deserialized JVM objects. This is very fast in the performance perspective, because it can be retrieved directly without any cost. It has some side effects, one of them being increase in the GC pressure as there is lot of data sitting inside your cache.</p>

<p>To reduce the side effects of <em>cache</em> spark provides two more levels of caching.</p>

<ul>
  <li>
    <p>MEMORY_ONLY_SER - This mode decreases GC problems by saving all of the objects in serialized format as one object from the perspective of java memory management. The only trade off here is, since data is stored in serialized format spark does deserialization on the fly to access data. This can be quite time consuming than the other one.</p>
  </li>
  <li>
    <p>MEMORY_AND_DISK - It avoids recomputation of the cached data whenever we access the data from disk. The only trade off here is , since we are hitting disk for the data it will be slow.</p>
  </li>
</ul>

<h2 id="other-aspects">Other aspects</h2>

<ul>
  <li>
    <p>Even though spark is a horizontally scalable engine, it is good to have more number of executors with optimal heap size rather than having executors with more memory. The optimum size of an executor is 64GB.</p>
  </li>
  <li>
    <p>Use LZF compression to improve shuffle performace.</p>
  </li>
</ul>

<pre>
<code data-trim="" class="Scala">
 conf.set("spark.io.compression.codec","lzf")
</code>
</pre>

<ul>
  <li>Turn on speculative execution to help prevent stragglers.</li>
</ul>

<pre>
<code data-trim="" class="Scala">
 conf.set("spark.speculation","true")
</code>
</pre>

<ul>
  <li>Make sure spark has enough disks to store the shuffled data. Normally spark tries to move data across disks if memory runs out. It is set using following properties</li>
</ul>

<ol>
  <li>
    <p>In YARN mode, inherits YARNâ€™s local directories</p>
  </li>
  <li>
    <p>SPARK_LOCAL_DIRS in mesos/standalone mode</p>
  </li>
</ol>

<p><strong>Note</strong> All the above mentioned tweaks may not yield performance improvement in every spark application. The main aim of this blog is to provide an overview of pinpoints where one can improve the performance of spark application.</p>

<p>Hope you enjoyed reading this blog and it benefits you.</p>



          
          <br><br>
          
<!-- Social Buttons Start -->
<style>
.social-buttons {
  text-align: center !important;
  margin: 0 0 25px;
  font-size: 18px;
  line-height: 1.5;
  list-style-position: inside;
}
</style>
<ul class="list-inline social-buttons">
  
    <li><a href="https://twitter.com/shashidhares" target="_blank"><i class="fa fa-twitter fa-fw"></i></a></li>
  
    <li><a href="https://github.com/shasidhar" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
  
    <li><a href="https://www.linkedin.com/in/shasidhares" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
  
    <li><a href="https://www.facebook.com/shashidhar.eranti" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></li>
  
</ul>

<!-- Social Buttons End -->


        </div>
      </div>
    </section>

    
 <!-- Footer Start -->

<footer>
    <div class="container text-center">
      <!-- <p>Copyright &copy; Shashidhar 2015</p> -->
    </div>
</footer>

<p><br><br><br><br><br><br></p>

<!-- Footer End -->


    
<!-- Javascript Start -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- Plugin JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--* Start Bootstrap - Grayscale Bootstrap Theme (http://startbootstrap.com)
* Code licensed under the Apache License v2.0.
* For details, see http://www.apache.org/licenses/LICENSE-2.0.-->
<script>
function toggleNavCollapse(){50<$(".navbar").offset().top?$(".navbar-fixed-top").addClass("top-nav-collapse"):$(".navbar-fixed-top").removeClass("top-nav-collapse");}
$(document).ready(toggleNavCollapse);
$(window).scroll(toggleNavCollapse);$(function(){$("a.page-scroll").bind("click",function(b){var a=$(this);$("html, body").stop().animate({scrollTop:$(a.attr("href")).offset().top-50},1500,"easeInOutExpo",function(){a.blur()});b.preventDefault()})});$(".navbar-collapse ul li a").click(function(){$(".navbar-toggle:visible").click()});
</script>

 <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-71064079-1', 'auto');
    ga('send', 'pageview');
  </script>









  <!-- Disqus -->

  

  







<script>
function addTohistory() {
  if (!window.location.host.startsWith("127.0.0.1")) {
    history.pushState({}, 'Apache Spark Performance Tuning', 'https://shasidhare.com/spark/2015/11/03/apache-spark-performance-tuning.html');
  }
}
</script>









<!-- Javascript End -->


  </body>
</html>

<!-- Post Layout End -->
